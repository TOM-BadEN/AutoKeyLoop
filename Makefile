#---------------------------------------------------------------------------------
# AutoKeyLoop 主 Makefile
# 用于编译 ovl 和 sys 模块，并将编译产物复制到 out 目录
#---------------------------------------------------------------------------------

.PHONY: all clean ovl sys prepare-out

# 模块目录
OVL_DIR := ovl-AutoKeyLoop
SYS_DIR := sys-AutoKeyLoop

# 输出目录
OUT_DIR := out
OUT_SWITCH := $(OUT_DIR)/switch
OUT_OVERLAYS := $(OUT_SWITCH)/.overlays
OUT_ATMOSPHERE := $(OUT_DIR)/atmosphere/contents/4100000002025924

# 编译产物路径
OVL_OUTPUT := $(OVL_DIR)/ovl-AutoKeyLoop.ovl
SYS_OUTPUT_DIR := $(SYS_DIR)/out/4100000002025924

#---------------------------------------------------------------------------------
# 默认目标：编译所有模块并复制到 out 目录
#---------------------------------------------------------------------------------
all: ovl sys prepare-out
	@echo "复制编译产物到 out 目录..."
	@mkdir -p $(OUT_OVERLAYS)
	@mkdir -p $(OUT_ATMOSPHERE)
	@mkdir -p $(OUT_SWITCH)
	@cp -f $(OVL_OUTPUT) $(OUT_OVERLAYS)/
	@cp -rf $(SYS_OUTPUT_DIR)/* $(OUT_ATMOSPHERE)/
	@echo "所有模块编译完成！"
	@echo "输出目录: $(OUT_DIR)/"

#---------------------------------------------------------------------------------
# 编译 overlay 模块
#---------------------------------------------------------------------------------
ovl:
	@echo "========================================"
	@echo "编译 overlay 模块..."
	@echo "========================================"
	@$(MAKE) -C $(OVL_DIR)

#---------------------------------------------------------------------------------
# 编译 sysmodule 模块
#---------------------------------------------------------------------------------
sys:
	@echo "========================================"
	@echo "编译 sysmodule 模块..."
	@echo "========================================"
	@$(MAKE) -C $(SYS_DIR)

#---------------------------------------------------------------------------------
# 准备输出目录
#---------------------------------------------------------------------------------
prepare-out:
	@mkdir -p $(OUT_DIR)
	@mkdir -p $(OUT_OVERLAYS)
	@mkdir -p $(OUT_ATMOSPHERE)
	@mkdir -p $(OUT_SWITCH)

#---------------------------------------------------------------------------------
# 清理所有编译产物
#---------------------------------------------------------------------------------
clean:
	@echo "清理所有编译产物..."
	@$(MAKE) -C $(OVL_DIR) clean
	@$(MAKE) -C $(SYS_DIR) clean
	@rm -rf $(OUT_DIR)
	@echo "清理完成！"

